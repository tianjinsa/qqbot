# AstrBot 防推销插件

一个智能的群聊推销信息检测和处理插件，使用大语言模型(LLM)自动识别推销消息并进行相应处理。

## 功能特性

- 🤖 **智能检测**: 使用大语言模型智能判断消息是否为推销信息
- 🖼️ **图片识别**: 支持使用视觉模型提取图片中的文字信息进行检测
- 📝 **上下文分析**: 结合消息上下文提高检测准确性
- 👥 **白名单管理**: 支持用户白名单，白名单用户消息不会被检测
- 📤 **自动转发**: 检测到推销信息后自动转发到管理员群
- 🗑️ **批量撤回**: 自动撤回用户最近时间内的所有消息（如果平台支持）
- 🔇 **自动禁言**: 自动禁言发送推销信息的用户（可配置时长）
- ⚠️ **智能提醒**: 在原群聊发送自定义的提醒消息
- 📊 **消息追溯**: 可配置回溯时间，收集用户最近的所有消息

## 安装使用

1. 将插件文件夹放入 AstrBot 的 `data/plugins/` 目录
2. 重启 AstrBot 或在管理面板重载插件
3. 在插件配置页面设置相关参数

## 配置说明

### 必填配置

- **ADMIN_CHAT_ID**: 管理员群聊ID，推销消息将转发到此群聊
- **TEXT_MODEL_API_KEY**: 文本模型API密钥
- **VISION_MODEL_API_KEY**: 视觉模型API密钥（可与文本模型使用相同密钥）

### 可选配置

- **LAST_TIME**: 回溯时间范围（分钟），默认5分钟
- **SPAM_ALERT_MESSAGE**: 检测到推销后的提示消息
- **CONTEXT_MESSAGE_COUNT**: 上下文消息数量，默认1条
- **MUTE_DURATION**: 禁言时长（秒），默认600秒（10分钟）
- **WHITELIST_USERS**: 白名单用户列表
- **WHITELIST_GROUPS**: 白名单群聊列表，只检测白名单内的群聊
- **LLM_SYSTEM_PROMPT**: 自定义LLM系统提示词

### 模型配置

- **TEXT_MODEL_ID**: 文本模型名称，默认 gpt-3.5-turbo
- **TEXT_MODEL_BASE_URL**: 文本模型API地址，默认 OpenAI API
- **VISION_MODEL_ID**: 视觉模型名称，默认 gpt-4-vision-preview  
- **VISION_MODEL_BASE_URL**: 视觉模型API地址，默认 OpenAI API
- **MODEL_TIMEOUT**: 模型请求超时时间（秒），默认30秒

## 管理命令

### 测试功能

```bash
/spam_test <消息内容>             # 测试推销检测功能
```

## 工作流程

1. **消息监听**: 监听所有群聊消息
2. **群聊白名单检查**: 检查群聊是否在白名单中（如果配置了白名单）
3. **用户白名单检查**: 检查发送者是否在白名单中
4. **内容提取**: 如果包含图片，使用视觉模型提取图片内容
5. **上下文获取**: 获取指定数量的上下文消息
6. **AI判断**: 调用LLM判断是否为推销信息
7. **自动处理**：
   - 收集用户最近消息
   - 撤回用户最近所有消息
   - 禁言用户（可配置时长）
   - 转发到管理员群（包含原群聊ID）
   - 发送提醒消息## 注意事项

- 需要配置文本模型和视觉模型的API密钥才能正常工作
- 支持OpenAI兼容的API格式，可使用各种第三方模型服务
- 消息撤回和禁言功能依赖平台支持（如aiocqhttp）
- 建议根据实际情况调整系统提示词以提高检测准确性
- 白名单用户的消息不会被检测，请谨慎添加
- 群聊白名单为空时检测所有群聊，配置后只检测白名单内的群聊
- 禁言功能需要机器人有相应的管理员权限
- 转发到管理员群的消息包含原群聊ID，便于管理员识别来源
- 群管理员可以手动解除禁言，无需插件命令
- 建议设置合理的模型请求超时时间，避免长时间等待

## 版本历史

### v1.0.0

- 初始版本发布
- 支持基本的推销信息检测和处理功能
- 支持用户和群聊白名单管理
- 支持图片内容识别
- 支持消息撤回和用户禁言
- 支持自定义文本和视觉模型配置
- 支持OpenAI兼容的API格式
- 支持消息转发到管理员群
- 支持批量撤回用户最近消息
- 支持自动禁言功能

## 许可证

本插件遵循 MIT 许可证。

## 支持

如有问题或建议，请在 GitHub 仓库提交 Issue。
