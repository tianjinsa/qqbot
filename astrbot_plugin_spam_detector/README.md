# AstrBot 防推销插件

一个智能的群聊推销信息检测和处理插件，使用大语言模型(LLM)自动识别推销消息并进行相应处理。

## 功能特性

- 🤖 **智能检测**: 使用大语言模型智能判断消息是否为推销信息
- 🖼️ **图片识别**: 支持使用视觉模型提取图片中的文字信息进行检测
- 📝 **上下文分析**: 结合消息上下文提高检测准确性
- 👥 **白名单管理**: 支持用户白名单，白名单用户消息不会被检测
- 📤 **自动转发**: 检测到推销信息后自动转发到管理员群
- 🗑️ **自动撤回**: 自动撤回检测到的推销消息（如果平台支持）
- ⚠️ **智能提醒**: 在原群聊发送自定义的提醒消息
- 📊 **消息追溯**: 可配置回溯时间，收集用户最近的所有消息

## 安装使用

1. 将插件文件夹放入 AstrBot 的 `data/plugins/` 目录
2. 重启 AstrBot 或在管理面板重载插件
3. 在插件配置页面设置相关参数

## 配置说明

### 必填配置

- **ADMIN_CHAT_ID**: 管理员群聊ID，推销消息将转发到此群聊

### 可选配置

- **LAST_TIME**: 回溯时间范围（分钟），默认5分钟
- **SPAM_ALERT_MESSAGE**: 检测到推销后的提示消息
- **CONTEXT_MESSAGE_COUNT**: 上下文消息数量，默认1条
- **WHITELIST_USERS**: 白名单用户列表
- **LLM_SYSTEM_PROMPT**: 自定义LLM系统提示词

## 管理命令

### 白名单管理
```
/spam_whitelist add <用户ID>     # 添加用户到白名单
/spam_whitelist remove <用户ID>  # 从白名单移除用户
/spam_whitelist list             # 查看白名单
```

### 测试功能
```
/spam_test <消息内容>             # 测试推销检测功能
```

## 工作流程

1. **消息监听**: 监听所有群聊消息
2. **白名单检查**: 检查发送者是否在白名单中
3. **内容提取**: 如果包含图片，使用视觉模型提取图片内容
4. **上下文获取**: 获取指定数量的上下文消息
5. **AI判断**: 调用LLM判断是否为推销信息
6. **自动处理**: 
   - 收集用户最近消息
   - 转发到管理员群
   - 撤回原消息
   - 发送提醒消息

## 注意事项

- 需要配置可用的LLM提供商才能正常工作
- 消息撤回功能依赖平台支持（如aiocqhttp）
- 建议根据实际情况调整系统提示词以提高检测准确性
- 白名单用户的消息不会被检测，请谨慎添加

## 版本历史

### v1.0.0
- 初始版本发布
- 支持基本的推销信息检测和处理功能
- 支持白名单管理
- 支持图片内容识别
- 支持消息转发和撤回

## 许可证

本插件遵循 MIT 许可证。

## 支持

如有问题或建议，请在 GitHub 仓库提交 Issue。
