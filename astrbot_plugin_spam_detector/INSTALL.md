# AstrBot 防推销插件安装指南

## 快速安装

### 1. 下载插件
将整个 `astrbot_plugin_spam_detector` 文件夹复制到 AstrBot 的 `data/plugins/` 目录下。

### 2. 重载插件
在 AstrBot WebUI 的插件管理页面中找到 "astrbot_plugin_spam_detector"，点击 "重载插件"。

### 3. 配置插件
在插件管理页面点击 "管理" -> "配置"，填写必要的配置项。

## 详细配置

### 必填配置项

#### ADMIN_CHAT_ID (必填)
- **说明**: 管理员群聊ID，检测到的推销消息将转发到此群聊
- **获取方法**: 
  - QQ群：直接使用群号
  - 其他平台：查看具体平台的群组ID格式
- **示例**: `123456789`

### 可选配置项

#### LAST_TIME
- **说明**: 检测到推销后回溯用户消息的时间范围（分钟）
- **默认值**: 5
- **建议值**: 3-10分钟

#### SPAM_ALERT_MESSAGE
- **说明**: 检测到推销后在原群聊发送的提示消息
- **默认值**: "⚠️ 检测到疑似推销信息，该消息已被处理。"
- **可自定义**: 可以修改为符合你群聊风格的提示语

#### CONTEXT_MESSAGE_COUNT
- **说明**: 调用AI时包含的上下文消息数量
- **默认值**: 1
- **建议值**: 1-3条（过多会增加API调用成本）

#### WHITELIST_USERS
- **说明**: 白名单用户列表，这些用户的消息不会被检测
- **格式**: 用户ID列表
- **示例**: `["12345", "67890"]`

#### LLM_SYSTEM_PROMPT
- **说明**: AI检测推销信息时使用的系统提示词
- **默认值**: 已优化的推销检测提示词
- **自定义**: 可根据群聊特点调整检测标准

## 使用前检查

### 1. 确保LLM配置正确
插件依赖AstrBot的LLM功能，请确保：
- 已配置可用的LLM提供商（如OpenAI、Claude等）
- LLM服务正常工作
- 有足够的API调用额度

### 2. 确保机器人权限
- 机器人需要有群聊管理员权限（用于撤回消息）
- 确保机器人能够向管理员群发送消息

### 3. 测试配置
使用管理员命令测试功能：
```
/spam_test 这是一条测试推销消息，添加微信123456购买产品
```

## 管理命令

### 白名单管理
```bash
# 添加用户到白名单
/spam_whitelist add 123456

# 从白名单移除用户
/spam_whitelist remove 123456

# 查看当前白名单
/spam_whitelist list
```

### 功能测试
```bash
# 测试推销检测
/spam_test 这里输入要测试的消息内容
```

## 常见问题

### Q: 插件无法检测推销信息
**A**: 请检查：
1. LLM服务是否正常
2. 系统提示词是否合适
3. 查看日志中的错误信息

### Q: 消息无法撤回
**A**: 消息撤回功能依赖：
1. 平台支持（目前支持aiocqhttp）
2. 机器人有管理员权限
3. 消息发送时间不能太久

### Q: 误判率过高
**A**: 可以尝试：
1. 调整系统提示词，增加更具体的判断标准
2. 增加上下文消息数量
3. 将经常误判的用户加入白名单

### Q: 检测不够及时
**A**: 
- 检测速度主要取决于LLM响应速度
- 可以选择响应更快的LLM提供商
- 减少上下文消息数量可以提高速度

## 安全建议

1. **谨慎设置白名单**: 只将完全信任的用户加入白名单
2. **定期检查日志**: 关注插件运行日志，及时发现问题
3. **备份配置**: 定期备份插件配置，防止意外丢失
4. **测试新版本**: 升级插件前先在测试环境验证

## 性能优化

1. **合理设置上下文数量**: 过多上下文会增加API成本和响应时间
2. **定期清理白名单**: 移除不再需要的白名单用户
3. **监控API使用量**: 避免超出LLM服务的使用限制

## 支持

如果遇到问题：
1. 查看AstrBot日志文件
2. 检查插件配置是否正确
3. 在GitHub仓库提交Issue
4. 加入AstrBot官方群组寻求帮助
