# AstrBot 垃圾信息检测插件 - 批量处理配置说明

## 新增配置项

### 队列和批量处理配置
- `QUEUE_RATE_LIMIT`: 队列处理速率限制（秒）
  - 默认值: 1.0
  - 说明: 控制AI模型调用的最小间隔时间，避免频繁调用

- `BATCH_PROCESS_SIZE`: 批量处理大小
  - 默认值: 3
  - 说明: 一次批量处理的最大消息数量

- `BATCH_MAX_TEXT_LENGTH`: 批量处理最大文本长度（字符数）
  - 默认值: 2000
  - 说明: 批量处理时所有消息内容的最大总字符数，超出此限制的消息将单独处理

### 文本模型配置
- `TEXT_MODEL_TEMPERATURE`: 文本模型温度
  - 默认值: 0.7
  - 说明: 控制模型生成的随机性，0-2之间

- `TEXT_MODEL_THINKING_ENABLED`: 启用思考模式
  - 默认值: False
  - 说明: 是否为文本模型启用思考模式

### 视觉模型配置
- `VISION_MODEL_TEMPERATURE`: 视觉模型温度
  - 默认值: 0.7
  - 说明: 控制模型生成的随机性，0-2之间

- `VISION_MODEL_THINKING_ENABLED`: 启用思考模式
  - 默认值: False
  - 说明: 是否为视觉模型启用思考模式

- `VISION_MODEL_SYSTEM_PROMPT`: 视觉模型系统提示词
  - 默认值: "You are a helpful AI assistant."
  - 说明: 自定义视觉模型的系统提示词

## 批量处理逻辑

### 智能批量分组
- 按群组ID自动分组消息
- 根据`BATCH_PROCESS_SIZE`和`BATCH_MAX_TEXT_LENGTH`同时限制批量处理规模
- 优先满足字数限制，确保批量处理效率

### 处理策略
1. **批量处理**: 符合条件的消息进行批量检测，返回JSON格式: `{"y":[user_id1,user_id2]}`
2. **单独处理**: 超出批量限制的消息单独检测，无字数限制
3. **回退机制**: 批量处理失败时自动回退到单独处理

### 性能优化
- 移除了原有的单条消息处理逻辑，简化代码结构
- 移除了context_messages参数，减少不必要的上下文处理
- 智能字数控制，避免超长文本影响模型性能

## 配置示例

```yaml
# 队列和批量处理
QUEUE_RATE_LIMIT: 1.0
BATCH_PROCESS_SIZE: 5
BATCH_MAX_TEXT_LENGTH: 3000

# 文本模型配置
TEXT_MODEL_TEMPERATURE: 0.8
TEXT_MODEL_THINKING_ENABLED: true

# 视觉模型配置
VISION_MODEL_TEMPERATURE: 0.6
VISION_MODEL_THINKING_ENABLED: false
VISION_MODEL_SYSTEM_PROMPT: "You are a professional spam detection assistant for visual content."
```

## 注意事项

1. **字数限制**: 仅批量处理有字数限制，单条消息检测无限制
2. **处理优先级**: 优先进行批量处理，超出限制的消息自动单独处理
3. **性能平衡**: 合理设置批量大小和字数限制，平衡检测效率和准确性
4. **思考模式**: 启用思考模式可能增加响应时间但提高准确性
