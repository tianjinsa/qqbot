# `_process_batch_tasks` é‡å¤é€»è¾‘é‡æ„æŠ¥å‘Š

## ğŸ” å‘ç°çš„é‡å¤é€»è¾‘

### 1. **æ¶ˆæ¯å†…å®¹åˆå¹¶é€»è¾‘**ï¼ˆé‡å¤3æ¬¡ï¼‰
- ä¸»æ‰¹é‡å¤„ç†ä¸­çš„æ¶ˆæ¯åˆå¹¶
- å‰©ä½™ä»»åŠ¡å¤„ç†ä¸­çš„æ¶ˆæ¯åˆå¹¶  
- é”™è¯¯å›é€€å¤„ç†ä¸­çš„æ¶ˆæ¯åˆå¹¶

### 2. **ä»»åŠ¡è§£åŒ…é€»è¾‘**ï¼ˆé‡å¤4æ¬¡ï¼‰
- æ¯æ¬¡éƒ½éœ€è¦è§£åŒ… `task` å…ƒç»„è·å–å„ä¸ªå­—æ®µ

### 3. **æ‰¹é‡æ£€æµ‹å’Œç»“æœå¤„ç†é€»è¾‘**ï¼ˆé‡å¤3æ¬¡ï¼‰
- æ„å»ºæ‰¹é‡è¾“å…¥å­—å…¸
- è°ƒç”¨æ‰¹é‡æ£€æµ‹API
- å¤„ç†æ£€æµ‹ç»“æœçš„å¾ªç¯

### 4. **æ¨é”€æ¶ˆæ¯å¤„ç†é€»è¾‘**ï¼ˆé‡å¤4æ¬¡ï¼‰
- ç›¸åŒçš„æ—¥å¿—è®°å½•æ ¼å¼
- ç›¸åŒçš„å¤„ç†å‡½æ•°è°ƒç”¨

## âœ… é‡æ„åçš„æ”¹è¿›

### æ–°å¢è¾…åŠ©æ–¹æ³•

#### 1. `_build_full_content(task)` - æ¶ˆæ¯å†…å®¹æ„å»º
```python
def _build_full_content(self, task: tuple) -> str:
    """æ„å»ºå®Œæ•´çš„æ¶ˆæ¯å†…å®¹ï¼ˆæ–‡æœ¬+å›¾ç‰‡ï¼‰"""
    _, user_id, user_name, message_content, timestamp, event, image_content = task
    full_content = message_content
    if image_content:
        full_content += f"\nå›¾ç‰‡å†…å®¹ï¼š{image_content}"
    return full_content
```

#### 2. `_extract_task_info(task)` - ä»»åŠ¡ä¿¡æ¯æå–
```python
def _extract_task_info(self, task: tuple) -> tuple:
    """æå–ä»»åŠ¡ä¿¡æ¯"""
    _, user_id, user_name, message_content, timestamp, event, image_content = task
    return user_id, user_name, message_content, timestamp, event, image_content
```

#### 3. `_process_task_batch(tasks, group_id, batch_type)` - æ‰¹é‡å¤„ç†
```python
async def _process_task_batch(self, tasks: List[tuple], group_id: str, batch_type: str):
    """å¤„ç†ä¸€æ‰¹ä»»åŠ¡"""
    # ç»Ÿä¸€çš„æ‰¹é‡å¤„ç†é€»è¾‘
    # æ„å»ºæ‰¹é‡è¾“å…¥ -> æ‰¹é‡æ£€æµ‹ -> å¤„ç†ç»“æœ
```

#### 4. `_process_single_task(task, group_id, reason)` - å•ä»»åŠ¡å¤„ç†
```python
async def _process_single_task(self, task: tuple, group_id: str, reason: str):
    """å¤„ç†å•ä¸ªä»»åŠ¡"""
    # ç»Ÿä¸€çš„å•ä»»åŠ¡å¤„ç†é€»è¾‘
```

#### 5. `_handle_spam_detection_result(...)` - ç»“æœå¤„ç†
```python
async def _handle_spam_detection_result(self, user_id: str, user_name: str, group_id: str, event, context: str):
    """å¤„ç†æ¨é”€æ£€æµ‹ç»“æœ"""
    # ç»Ÿä¸€çš„ç»“æœå¤„ç†é€»è¾‘
```

### é‡æ„åçš„ä¸»æ–¹æ³•ç»“æ„

```python
async def _process_batch_tasks(self, group_id: str, tasks: List[tuple]):
    try:
        # 1. åˆ†ç»„ä»»åŠ¡ï¼ˆä¸»æ‰¹é‡ vs å‰©ä½™ä»»åŠ¡ï¼‰
        main_batch_tasks, remaining_tasks = self._split_tasks(tasks)
        
        # 2. å¤„ç†ä¸»æ‰¹é‡
        if main_batch_tasks:
            await self._process_task_batch(main_batch_tasks, group_id, "ä¸»æ‰¹é‡")
        
        # 3. å¤„ç†å‰©ä½™ä»»åŠ¡
        if remaining_tasks:
            await self._process_task_batch(remaining_tasks, group_id, "å‰©ä½™ä»»åŠ¡")
            
    except Exception as e:
        # 4. é”™è¯¯å›é€€ï¼šé€æ¡å¤„ç†
        for task in tasks:
            await self._process_single_task(task, group_id, "å›é€€å¤„ç†")
```

## ğŸ“Š é‡æ„æ•ˆæœ

### ä»£ç è¡Œæ•°å¯¹æ¯”
- **é‡æ„å‰**: ~80è¡Œå¤æ‚é€»è¾‘ï¼Œå¤§é‡é‡å¤ä»£ç 
- **é‡æ„å**: ~50è¡Œä¸»é€»è¾‘ + 5ä¸ªä¸“ç”¨è¾…åŠ©æ–¹æ³•

### å¯ç»´æŠ¤æ€§æå‡
1. **å•ä¸€èŒè´£**: æ¯ä¸ªæ–¹æ³•åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½
2. **å¤ç”¨æ€§**: é‡å¤é€»è¾‘è¢«æå–ä¸ºå¯å¤ç”¨çš„æ–¹æ³•
3. **å¯è¯»æ€§**: ä¸»æµç¨‹æ›´åŠ æ¸…æ™°ï¼Œæ˜“äºç†è§£
4. **å¯æµ‹è¯•æ€§**: æ¯ä¸ªè¾…åŠ©æ–¹æ³•éƒ½å¯ä»¥ç‹¬ç«‹æµ‹è¯•

### åŠŸèƒ½ä¿æŒ
- âœ… æ‰€æœ‰åŸæœ‰åŠŸèƒ½å®Œå…¨ä¿æŒ
- âœ… é”™è¯¯å¤„ç†æœºåˆ¶ä¿æŒä¸å˜
- âœ… æ—¥å¿—è®°å½•æ ¼å¼ä¿æŒä¸€è‡´
- âœ… æ€§èƒ½ç‰¹å¾ä¿æŒä¸å˜

## ğŸ¯ é‡æ„ä¼˜åŠ¿

1. **æ¶ˆé™¤é‡å¤**: 4ä¸ªé‡å¤é€»è¾‘å—è¢«åˆå¹¶ä¸ºå¯å¤ç”¨æ–¹æ³•
2. **æé«˜å¯ç»´æŠ¤æ€§**: ä¿®æ”¹é€»è¾‘æ—¶åªéœ€è¦åœ¨ä¸€ä¸ªåœ°æ–¹ä¿®æ”¹
3. **å¢å¼ºå¯è¯»æ€§**: ä¸»æµç¨‹æ›´åŠ æ¸…æ™°ï¼Œå…³æ³¨ç‚¹åˆ†ç¦»
4. **ä¾¿äºæ‰©å±•**: æ–°å¢å¤„ç†é€»è¾‘æ—¶å¯ä»¥å¤ç”¨ç°æœ‰è¾…åŠ©æ–¹æ³•
5. **å‡å°‘bugé£é™©**: é‡å¤ä»£ç å®¹æ˜“äº§ç”Ÿä¸ä¸€è‡´çš„ä¿®æ”¹ï¼Œç°åœ¨åªæœ‰ä¸€ä»½å®ç°

è¿™æ¬¡é‡æ„æˆåŠŸæ¶ˆé™¤äº† `_process_batch_tasks` æ–¹æ³•ä¸­çš„é‡å¤é€»è¾‘ï¼Œæé«˜äº†ä»£ç è´¨é‡å’Œå¯ç»´æŠ¤æ€§ã€‚
