# 新转发逻辑说明

## 修改概述

按照用户要求，已对推销检测的转发逻辑进行了重大改进，新的处理流程如下：

## 新的处理流程

### 1. 队列清理（步骤0）
- **新增功能**：在处理推销消息时，首先清理检测队列中同一群聊同一用户的重复任务
- **原理**：避免同一用户的多条消息重复处理，因为撤回阶段会一起撤回所有消息
- **实现方法**：`_clear_user_detection_queue()` 方法

### 2. 用户禁言（步骤1）
- 保持原有逻辑，先禁言违规用户

### 3. 获取消息池（步骤2）
- 从消息池中获取该用户的所有消息，但**不立即撤回**

### 4. 合并转发（步骤3 - 核心改进）
- **新增功能**：在撤回消息之前，先将需要撤回的消息通过合并转发发送到管理员群
- **实现方式**：
  - 使用 AstrBot 的 `Node` 组件构建合并转发消息
  - 每条消息作为一个独立的节点，保留发送时间和用户信息
  - 包含推销检测报告标题节点
- **备用方案**：如果合并转发失败，自动回退到文本转发模式

### 5. 消息撤回（步骤4）
- **重新排序**：转发完成后再执行撤回操作
- 遍历用户消息池，撤回所有消息
- 从消息池中删除已撤回的消息

### 6. 后续处理（步骤5-6）
- 清理过期消息
- 发送警告消息到原群聊

## 技术实现

### 核心新增方法

1. **`_clear_user_detection_queue(group_id, user_id)`**
   - 清理检测队列中指定用户的重复任务
   - 避免不必要的重复检测

2. **`_forward_messages_as_merged(admin_chat_id, group_id, user_id, user_name, user_messages, event)`**
   - 使用合并转发方式发送推销检测报告
   - 支持 aiocqhttp 平台的原生合并转发 API
   - 自动回退到文本转发模式

3. **`_forward_to_admin_text(admin_chat_id, group_id, user_id, user_name, user_messages, event)`**
   - 文本形式转发的备用实现
   - 确保在合并转发失败时也能正常转发

### 合并转发格式

```
🚨 推销检测报告
👤 用户: 张三 (123456789)  
🏷️ 原群聊: 技术交流群 (987654321)
⏰ 时间: 2024-XX-XX XX:XX:XX

└── [系统] AstrBot反推销系统
    ├── [XX:XX:XX] 张三: 第一条推销消息
    ├── [XX:XX:XX] 张三: 第二条推销消息  
    └── [XX:XX:XX] 张三: 第三条推销消息
```

## 优势对比

### 修改前的问题
- 先撤回再转发，管理员只能看到文本描述
- 可能出现重复检测同一用户的情况
- 转发信息不够直观

### 修改后的优势
- ✅ **先转发再撤回**：管理员能看到原始消息格式
- ✅ **合并转发**：消息以对话气泡形式展示，更直观
- ✅ **避免重复处理**：清理队列中的重复任务
- ✅ **完整时间信息**：每条消息都有精确的发送时间
- ✅ **兼容性强**：支持多种转发方式，有完善的回退机制

## 配置要求

无需额外配置，使用现有的 `ADMIN_CHAT_ID` 配置项即可。

## 平台兼容性

- **aiocqhttp**: 完全支持合并转发和文本转发
- **其他平台**: 自动使用文本转发模式

## 注意事项

1. 合并转发需要 aiocqhttp 平台支持
2. 如果合并转发失败，会自动回退到文本转发
3. 队列清理功能确保不会重复处理同一用户的消息
4. 所有操作都有详细的日志记录，便于调试
