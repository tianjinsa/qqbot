# 垃圾信息检测插件 - 统一批量检测改进

## 修改概述

已将所有单条消息检测逻辑统一改为使用批量检测方法 `_batch_spam_detection`，完全移除了 `_is_spam_message` 方法。

## 主要改进

### 1. 统一检测逻辑
- **移除方法**: 完全删除了 `_is_spam_message` 方法
- **统一接口**: 所有检测都通过 `_batch_spam_detection` 进行
- **一致性**: 确保所有检测结果格式统一为 JSON: `{"y":[user_id1,user_id2]}`

### 2. 优化处理流程

#### 超长消息处理
```python
# 原来: 调用单条检测
is_spam = await self._is_spam_message(message_content, image_content)

# 现在: 使用单条批量检测
single_batch_input = {user_id: full_content}
spam_user_ids = await self._batch_spam_detection(single_batch_input)
is_spam = user_id in spam_user_ids
```

#### 剩余任务处理
```python
# 原来: 逐条单独检测
for task in remaining_tasks:
    is_spam = await self._is_spam_message(message_content, image_content)

# 现在: 批量检测剩余任务
remaining_batch_input = {user_id: full_content for task in remaining_tasks}
spam_user_ids = await self._batch_spam_detection(remaining_batch_input)
```

#### 错误回退处理
```python
# 原来: 回退到单条检测
is_spam = await self._is_spam_message(message_content, image_content)

# 现在: 回退到单条批量检测
single_batch_input = {user_id: full_content}
spam_user_ids = await self._batch_spam_detection(single_batch_input)
```

#### 测试命令
```python
# 原来: 使用单条检测
is_spam = await self._is_spam_message(message, "")

# 现在: 使用批量检测测试
test_batch_input = {"test_user": message}
spam_user_ids = await self._batch_spam_detection(test_batch_input)
is_spam = "test_user" in spam_user_ids
```

### 3. 代码简化

#### 删除内容
- 移除了 `_is_spam_message` 方法（约50行代码）
- 移除了单条检测的系统提示词逻辑
- 移除了单条检测的返回值解析逻辑

#### 保留优势
- 保持了批量处理的效率优势
- 保持了统一的 JSON 格式输出
- 保持了可配置的温度和思考模式控制

## 性能提升

### 1. API调用优化
- **减少调用次数**: 即使是"单条"检测也使用批量接口，避免了两套不同的API调用逻辑
- **统一格式**: 所有检测结果都是相同的JSON格式，便于解析和处理

### 2. 代码维护性
- **单一职责**: 只有一个检测方法需要维护
- **逻辑统一**: 所有检测路径都使用相同的逻辑
- **配置一致**: 所有检测都使用相同的配置参数

### 3. 扩展性
- **易于扩展**: 只需修改一个批量检测方法即可影响所有检测逻辑
- **参数统一**: 所有检测都使用相同的系统提示词和模型参数

## 向后兼容性

- 所有功能保持不变，用户无需修改配置
- 测试命令 `/spam_test` 继续正常工作
- 所有检测结果格式保持一致

## 配置项保持不变

所有现有配置项继续有效：
- `BATCH_MAX_TEXT_LENGTH`: 批量处理最大文本长度
- `BATCH_PROCESS_SIZE`: 批量处理大小  
- `TEXT_MODEL_TEMPERATURE`: 文本模型温度
- `TEXT_MODEL_THINKING_ENABLED`: 思考模式
- `LLM_SYSTEM_PROMPT`: 系统提示词

## 总结

这次改进实现了：
1. **代码简化**: 移除了重复的检测逻辑，减少维护成本
2. **性能统一**: 所有检测都享受批量处理的优势
3. **逻辑一致**: 消除了单条和批量检测可能产生的结果差异
4. **易于维护**: 只需维护一套检测逻辑即可
